<!doctype html>
<html lang="en">
<head>
    <%- include('head'); %>
</head>
<body>

<div id="layout">
    <!-- Menu toggle -->
    <%- include('menulink'); %>

    <div id="menu">
        <%- include('menu'); %>
    </div>

    <div id="main">
        <div class="content">

            <h1>Lista scadenze</h1>
            
            <% if (scaduti.length > 0) { %>
                <h3>Scaduti</h3>
                <table class="pure-table scaduti">
                    <thead>
                        <th>Nome</th>
                        <th>Scadenza</th>
                        <th><!-- Mangiato --></th>
                    </thead>
                    <tbody>
                        <% for (var p in scaduti) { %>
                            <tr>
                                <td><%= scaduti[p].prodotto.nome %></td>
                                <td class='scadDate'><%= scaduti[p].scadenza %></td>
                                <td><button class="pure-button" data-id="<%= scaduti[p].id %>">Mangiato</button></td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            <% } %>

            <% if (inScadenza.length > 0) { %>
                <h3>Stanno per scadere</h3>
                <table class="pure-table inscad">
                    <thead>
                        <th>Nome</th>
                        <th>Scadenza</th>
                        <th><!-- Mangiato --></th>
                    </thead>
                    <tbody>
                        <% for (var p in inScadenza) { %>
                            <tr>
                                <td><%= inScadenza[p].prodotto.nome %></td>
                                <td class='scadDate'><%= inScadenza[p].scadenza %></td>
                                <td><button class="pure-button" data-id="<%= inScadenza[p].id %>">Mangiato</button></td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            <% } %>

            <% if (scadenze.length > 0) { %>
                <h3>Non in scadenza</h3>
                <table class="pure-table">
                    <thead>
                        <th>Nome</th>
                        <th>Scadenza</th>
                        <th><!-- Mangiato --></th>
                    </thead>
                    <tbody>
                        <% for (var p in scadenze) { %>
                            <tr>
                                <td><%= scadenze[p].prodotto.nome %></td>
                                <td class='scadDate'><%= scadenze[p].scadenza %></td>
                                <td><button class="pure-button" data-id="<%= scadenze[p].id %>">Mangiato</button></td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            <% } %>
        </div>
    </div>
</div>
<script>

    const stringToDate = (dateString, separator, r = true) => { //r = yyyy-mm-dd, not r = dd-mm-yyyy
        let dA = dateString.split(separator)
        if(dA.length !== 3)
            throw new Error("Impossibile parsare data");

        return new Date(`${dA[ r?0:2 ]}-${dA[1]}-${dA[ r?2:0 ]}T00:00:00`);
    }

    const outGiorni = async (data) => {
        let d = stringToDate(data, "-"),
            now = new Date(),
            start = new Date(),
            diff = now - d;
        
        start.setHours(0,0,0,0);
        diff -= now - start;
        diff -= diff%86400000;
        diff = diff/86400000;
        if(diff == 0)
            return "Scade oggi";
        else if(diff > 0)
            return `Da ${diff} Giorni`
        else
            return `Tra ${diff * -1} Giorni`
    }

    [...$(".scadDate")].forEach((e) => {
        outGiorni(e.innerText).then((x) => e.innerText = x);
    })
    
</script>
<script src="js/ui.js"></script>

</body>
</html>